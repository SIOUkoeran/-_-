# 지리적 정보에 색인을 만드는 방법

## 해시 기반 방안 

### 균등 격자
### 지오 해시
### 카르테시안 계층



## 트리 기반 방안

### 쿼드트리
> 격자의 내용이 특정 기준을 만족할 때까지 2차원 공간을 재귀적으로 사분면 분할하는데 사용되는 자료 구조.

> 질의에 답하는 데 사용될 트리 구조를 메모리 안에 만드는 것. 자료 구조는 각각의 LBS 서버에 존재, 서버가 시작하는 시점에 구축.
[간단한 구현](https://github.com/SIOUkoeran/system_architecture/blob/main/demo/src/test/java/com/example/demo/quadtree/QuadTreeRunner.java)


```java
public void buildQuadTree(TreeNode node) {
    if (countNumberOfBusinessIncCurrentGrid(node) > 100) {
        node.subdivide();
        for (TreeNode child: node.getChildren() {
            buildQuadTree(child);
        })
    }
}

```
#### 쿼드트리 저장에 사용되는 메모리
- 격자를 식별하는 데 사용될 좌상단과 우하단 꼭짓점 좌표 : 32 Bytes
- 격자 내부 사업장 ID 목록 : 8Bytes * 100
>  832 Bytes

#### 쿼드트리로 주변 사업장 검색 
1. 메모리에 쿼드트리 인덱스를 구축
2. 검색 시작점이 포함된 말단 노드를 만날 때까지, 루트 노드부터 탐색


#### 쿼드트리 배포 및 운영 주의점
1. 배포 
> 모든 서버가 동시에 새로 배포되는 것이 아닌, 점진적으로 배포

2. 갱신
> 점진적 갱신 -> 키 무효화 -> 캐시 서버 부하

### 구글 S2 
> 메모리 기반. 지구를 힐베트르 곡선이라는 공간 채움 곡선을 사용하여 1차원 색인화하는 방안.

#### 장점

1. 이미 존재하는 경계선들을 묶어 설정할 수 있다.
2. 지오펜스를 활용하면 관심 있는 영역의 경계를 정한 다음 해당 경계를 벗어난 사용자에게 알림을 보낼 수 있다.
3. 영역 지정 알고리즘 (최소 수준, 최고 수준, 최대 셀 개수를 지정할 수 있다.)

엘라스틱 서치 : 지오해시 _ 쿼드트리

### R 트리


## 지오해시 vs 쿼드트리

### 지오해시 
- 구현과 사용이 쉽다. 트리를 구축할 필요 없다.
- 지정 반경 이내 사업장 검색을 지원한다.
- 정밀도를 고정하면 격자의 크기도 고정. 인구 밀도에 따라 동적으로 격자 크기를 조정할 수 없다. 
- 색인 갱신이 쉽다. 예를 들어 색인에서 사업장 하나를 삭제하려면 지오해시값과 사업장 식별자가 같은 열 하나를 제거하기만 하면 된다.

### 쿼드트리
- 구현하기가 지오해시에 비해 어렵다.
- k 번째로 가까운 사업장까지 목록을 구할 수 있다.
- 인구 밀도에 따라 격자 크기를 동적으로 조정할 수 있다.
- 지오해시에 비해서 색인 갱신이 까다롭다.  쿼드트리는 말 그대로 트리 형태 자료구조. 사업장 정보를 삭제하려면 루트 노드부터 말단 노드까지 트리를 순회해야 한다.다중 스레드를 지원해야하는 경우 구현이 더욱 복잡하다. 리밸런싱이 필요하다면 더욱 더 복잡해진다. 
-> 새로운 사업장을 추가할 수 없는 경우 리밸런싱 
> 해결책 : 말단 노드가 담당해야하는 구간의 크기를 필요한 양보다 크게 잡는 것.
